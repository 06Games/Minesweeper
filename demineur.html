<!doctype html>
<html lang="fr">
	<head>
		<meta charset="utf-8" />
		<title>Demineur</title>
		<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
		<style>
		
			.cache{
				font-size:0px;
				background-size: 0px 0px;
			}
				
			body{
				<!--background-image: url('Drift_of_Harrachov_Mine_(308587800).jpg')-->
			}
			
			table td{
				border: 5px solid #ccc;
				width: 60px;
				height: 60px;
				background-color: #f7f7f7;
			}

			table{
				border-collapse: collapse;
				position: absolute;
				top:50px;
				left:200px;
			}
			
			.afficheBomb{
				background-image: url('bomb.png');
				background-size: 60px 60px;			
			}

			button{
				height:40px;
				width:75px;
			}
			
			#start{
				position: absolute;
				top:5px;
				left:800px;
			}
			
			#restart{
				position: absolute;
				top:5px;
				left:700px;
			}
			
		</style>
	</head>
	<body>
		
		<button id="start" class="stop">Start</button>
		<button id="restart">Restart</button>
		<button id="triche">SUPER TRICHE</button>
		<button id="facile">FACILE</button>
		<button id="moyen">MOYEN</button>
		<button id="difficile">DIFFICILE</button>
		<button id="hardcore">HARDCORE</button>
		
		<table>		
		</table>

		<script>
		
			//demarage
			$('#start').click(function(){
				if ($('#start').hasClass("stop")){
					drawGrid();
					countAdjacentBombs();
					$('#start').removeClass("stop");
					$('#start').addClass("play");
				}
			});
			
			//redemarage
			$('#restart').click(function(){
				$('tr').remove();
				$('#start').removeClass("play");
				$('#start').addClass("stop");
				y = 0;
				x = 0;
			});
			
			//triche
			$('#triche').click(function(){
				$('.bomb').addClass('afficheBomb')
			})
			
			var width = 18; // nombre de colonnes
			var height = 10; // nombre de lignes
			var cBombe = 0.3;//chance d'avoir une bombe
			var nbBombe = 0; //nombre de bombe
			
			// referencement de la table
			var table = $('table');		
			
			// Trace la grille et place les bombes
			function drawGrid(){

				for (x = 0; x < height; x++) { 

					// crée une ligne
					var newRow = $('<tr></tr>');

					for (y = 0; y < width; y++) { 

						/// crée une colonne
						var cell = $('<td></td>');						
						
						// système de coordonnées
						cell.addClass('row'+x); // classe des lignes
						cell.addClass('col'+y); // classe des colonnes

						var random = 10*Math.random(); // génère un nombre entre 0 et 10
						
						//generation des bombes
						if(random < cBombe){
						    cell.addClass("bomb");
							nbBombe++
						}
						
						newRow.append(cell);
						
						//action du clic gauche
						cell.click(function(){
							$(this).removeClass("cache")
								
							if($(this).hasClass("bomb")){
								alert("Perdu!");
								$('.bomb').addClass("afficheBomb");
							}
							else if(nbBombe == $(".cache").size()){
								alert("Gagné!");
							}		
							else if ($(this).text() == '0'){
								explodeZeros($(this));
							}
						});
	
					}

					/// ajoute le tableau
					table.append(newRow);
				}
				
			} // fin de la fonction drawGrid

			x = 0;
			y = 0;
		
			//Calcul du nombre de bombe adjacente
			function countAdjacentBombs(){
				for (x = 0; x < height; x++){
					for (y = 0; y < width; y++){
						// si la case sur laquelle on est (x;y) n'est pas une bombe, alors...
						if( !$('.row'+x+'.col'+y).hasClass('bomb') ){

							var count = 0; // compteur de bombes

							if($('.row'+(x-1)+'.col'+(y-1)).hasClass('bomb')){ count++;}
							if($('.row'+(x-1)+'.col'+y).hasClass('bomb')){ count++;}
							if($('.row'+(x-1)+'.col'+(y+1)).hasClass('bomb')){ count++;}
							if($('.row'+x+'.col'+(y+1)).hasClass('bomb')){ count++;}
							if($('.row'+x+'.col'+(y-1)).hasClass('bomb')){ count++;}
							if($('.row'+(x+1)+'.col'+(y-1)).hasClass('bomb')){ count++;}
							if($('.row'+(x+1)+'.col'+y).hasClass('bomb')){ count++;}
							if($('.row'+(x+1)+'.col'+(y+1)).hasClass('bomb')){ count++;}

							// on met la valeur du compteur dans la case (x;y)
							$('.row'+x+'.col'+y).text(count);
							
							//cache les chifres
							$('.row'+x+'.col'+y).addClass("cache");
						}
					}
				} 
			} // fin de la fonction countAdjacentBombs
			
			//affiche les zeros
			function explodeZeros(cell){

				var col = parseInt(cell.attr('class').match(/\bcol(\d+)\b/)[1]);//Récupère le n° de colonne
				var row = parseInt(cell.attr('class').match(/\brow(\d+)\b/)[1]);//Récupère le n° de ligne
				
				//Sélection des cases autour
				var selectors = [
					'.col'+(col-1)+'.row'+(row-1),
					'.col'+col+'.row'+(row-1),
					'.col'+(col+1)+'.row'+(row-1),
					'.col'+(col-1)+'.row'+row,
					'.col'+(col+1)+'.row'+row,
					'.col'+(col-1)+'.row'+(row+1),
					'.col'+col+'.row'+(row+1),
					'.col'+(col+1)+'.row'+(row+1)
				];
				
				//Pour chacune des cases
				$.each(selectors, function(key){
					
					//Prend le sélecteur concerné
					var current_cell = $(selectors[key]);
					
					//Si le texte indique 0 ET que la case est cachée, alors on enlève la classe "cache" et on rappelle la méthode
					//On s'arrête lorsqu'on trouve autre chose que 0
					if(current_cell.text() == "0" && current_cell.hasClass('cache')){
						current_cell.removeClass('cache');
						explodeZeros(current_cell);
					} else {
						current_cell.removeClass('cache');		
					}		
				});
			}  
			
		</script>
	</body>
</html>